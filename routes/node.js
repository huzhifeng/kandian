var async = require('async');
var News = require('../models/news');
var tt = require('config').Config.neteaseTags;
var hotQty = require('config').Config.hotQty;
var mergeDict = require('../lib/utils').mergeDict;

tt = mergeDict(tt,require('config').Config.sohuTags);
tt = mergeDict(tt,require('config').Config.sinaTags);
tt = mergeDict(tt,require('config').Config.qqTags);
tt = mergeDict(tt,require('config').Config.ifengTags);
tt = mergeDict(tt,require('config').Config.yokaTags);
tt = mergeDict(tt,require('config').Config.krTags);

var index = function (req, res, next) {

  var tag = req.params.tag;

  var getNewss = function (callback) {
    var page = req.params.page || 1;
    News.page({tags: tag}, page, function (err, currentPage, pages, result) {
      if (! err) {
        callback(null, {currentPage: currentPage, pages: pages, newss: result});
      } else {
        callback(err);
      }
    });
  };
  var getHotNewss = function (callback) {
    News.findLimit({tags: tag}, hotQty, {views: -1}, function (err, result) {
      if (! err) {
        callback(null, {hotNewss: result});
      } else {
        callback(err);
      }
    });
  };

  async.parallel({
    newss: getNewss,
    hotNewss: getHotNewss
  },
  function (err, results) {
    if (! err) {
      // console.log(currentPage, pages);
      res.render('tag', {pageTitle: tag,
        currentPage: results.newss.currentPage, pages: results.newss.pages,
        news: results.newss.newss, tag: tag, active: tt[tag],
        baseUrl: '/tag/' + encodeURIComponent(tag) + '/page/',
        hotNews: results.hotNewss.hotNewss});
    } else {
      // console.log(err);
      next(new Error(err.message));
    }
  });

};

exports.index = index;